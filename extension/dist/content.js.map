{"version":3,"file":"content.js","sources":["../src/content/main.tsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\nimport { createRoot } from \"react-dom/client\";\n\nconst ROOT_ID = \"__inline_copilot_root__\";\n\nfunction ensureShadow(): ShadowRoot {\n  let host = document.getElementById(ROOT_ID) as HTMLElement | null;\n  if (!host) {\n    host = document.createElement(\"div\");\n    host.id = ROOT_ID;\n    host.style.all = \"initial\";\n    host.style.position = \"fixed\";\n    host.style.inset = \"auto 16px 16px auto\";\n    host.style.zIndex = \"2147483647\";\n    document.documentElement.appendChild(host);\n  }\n  return host.shadowRoot ?? host.attachShadow({ mode: \"open\" });\n}\n\nfunction UI() {\n  const [input, setInput] = useState(\"\");\n  const [out, setOut] = useState(\"\");\n  const portRef = useRef<chrome.runtime.Port | null>(null);\n\n  useEffect(() => {\n    const style = document.createElement(\"style\");\n    style.textContent = `\n      .panel{font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:12px;background:#111;color:#eee;border:1px solid #333;border-radius:12px;width:420px;box-shadow:0 8px 30px rgba(0,0,0,.35)}\n      .row{display:flex;gap:8px;margin-top:8px}\n      .btn{padding:8px 12px;background:#222;border:1px solid #444;border-radius:8px;cursor:pointer;color:#fff;}\n      .btn:hover{background:#2b2b2b}\n      .ta{width:100%; background:#0b0b0b; color:#eee; border:1px solid #333; border-radius:8px; padding:8px}\n      .out{white-space:pre-wrap; margin-top:10px; font:13px ui-monospace,Menlo,Consolas,monospace}\n    `;\n    ensureShadow().appendChild(style);\n  }, []);\n\n  const ask = async () => {\n    console.log(\"Asking:\", input);\n    if (!portRef.current) {\n      portRef.current = chrome.runtime.connect({ name: \"copilot\" });\n      portRef.current.onMessage.addListener((msg) => {\n        if (msg.type === \"delta\") setOut((p) => p + msg.token);\n        if (msg.type === \"done\" && msg.error) setOut((p) => p + \"\\n\\n[Error] \" + msg.error);\n      });\n    }\n    setOut(\"\");\n    // Get JWT from chrome.storage.local and attach to message (awaited, typed)\n    const result = await new Promise<{ jwt?: string }>((resolve) =>\n      chrome.storage.local.get([\"jwt\"], (items: { jwt?: string }) => resolve(items))\n    );\n    const jwt = result.jwt || \"\";\n    console.log(\"Using JWT:\", jwt);\n    portRef.current!.postMessage({ type: \"ask\", input, jwt });\n  };\n\n  /*const ask = async () => {\n    setOut(\"\");\n    try {\n      const res = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ input })\n      });\n      if (!res.ok) {\n        const text = await res.text();\n        setOut(`[Error] ${text}`);\n        return;\n      }\n      // Stream response\n      const reader = res.body?.getReader();\n      if (!reader) {\n        setOut(\"[Error] No response body\");\n        return;\n      }\n      let outStr = \"\";\n      const decoder = new TextDecoder();\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n        outStr += decoder.decode(value);\n        setOut(outStr);\n      }\n    } catch (err: any) {\n      setOut(`[Error] ${err.message || err}`);\n    }\n  };*/\n\n  return (\n    <div className=\"panel\">\n      <div style={{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\"}}>\n        <strong>Inline Copilot</strong>\n        <button className=\"btn\" onClick={() => ((ensureShadow() as any).host.style.display = \"none\")}>Close</button>\n      </div>\n      <textarea className=\"ta\" rows={4} value={input} onChange={(e)=>setInput(e.target.value)}\n        placeholder=\"Ask anything... (Enter to send, Shift+Enter = newline)\"\n        onKeyDown={(e)=>{ if(e.key===\"Enter\" && !e.shiftKey){ e.preventDefault(); ask(); }}} />\n      <div className=\"row\">\n        <button className=\"btn\" onClick={ask}>Ask</button>\n        <button className=\"btn\" onClick={()=>{ setInput(\"\"); setOut(\"\"); }}>Clear</button>\n      </div>\n      <div className=\"out\">{out}</div>\n    </div>\n  );\n}\n\nfunction mount() {\n  const shadow = ensureShadow();\n  const prevMount = shadow.querySelector('div[data-copilot-mount]');\n  if (prevMount) prevMount.remove();\n  const mountEl = document.createElement(\"div\");\n  mountEl.setAttribute(\"data-copilot-mount\", \"true\");\n  shadow.appendChild(mountEl);\n  (shadow as any).host.style.display = \"none\"; // start hidden\n  createRoot(mountEl).render(<UI />);\n}\n\nfunction getTargetRect() {\n  // Try selection first\n  const sel = window.getSelection();\n  if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {\n    const range = sel.getRangeAt(0);\n    const rect = range.getBoundingClientRect();\n    // Only return rect if selection is visible and not inside our own popup\n    if (rect.width > 0 && rect.height > 0 && rect.top > 0 && rect.left > 0) {\n      // Check if selection is inside Copilot popup\n      const host = document.getElementById(ROOT_ID);\n      if (host && host.contains(sel.anchorNode as Node)) return null;\n      return rect;\n    }\n  }\n  // Fallback: focused element\n  const active = document.activeElement;\n  if (active && (active instanceof HTMLElement)) {\n    const rect = active.getBoundingClientRect();\n    // Only return rect if focused element is visible and not inside our own popup\n    if (rect.width > 0 && rect.height > 0 && rect.top > 0 && rect.left > 0) {\n      const host = document.getElementById(ROOT_ID);\n      if (host && host.contains(active)) return null;\n      return rect;\n    }\n  }\n  return null;\n}\n\nfunction positionPopup(host: HTMLElement, rect: DOMRect) {\n  const popupHeight = 220; // Approximate, could measure\n  const margin = 8;\n  const topSpace = rect.top;\n  if (topSpace > popupHeight + margin) {\n    // Place above\n    host.style.top = `${rect.top - popupHeight - margin + window.scrollY}px`;\n  } else {\n    // Place below\n    host.style.top = `${rect.bottom + margin + window.scrollY}px`;\n  }\n  host.style.left = `${rect.left + window.scrollX}px`;\n  host.style.right = \"auto\";\n  host.style.bottom = \"auto\";\n  host.style.position = \"absolute\";\n  host.style.zIndex = \"2147483647\";\n}\n\nchrome.runtime.onMessage.addListener((m) => {\n  if (m?.type === \"TOGGLE\") {\n    const host = (ensureShadow() as any).host as HTMLElement;\n    if (host.style.display === \"none\") {\n      const rect = getTargetRect();\n      if (rect) {\n        console.log('positioning popup near selection:', rect);\n        positionPopup(host, rect);\n      } else {\n        console.log('positioning popup in bottom right');\n        // Only set bottom right styles if no rect\n        host.style.position = \"fixed\";\n        host.style.inset = \"auto 16px 16px auto\";\n        host.style.top = \"auto\";\n        host.style.left = \"auto\";\n        host.style.right = \"16px\";\n        host.style.bottom = \"16px\";\n      }\n      host.style.display = \"block\";\n    } else {\n      host.style.display = \"none\";\n    }\n  }\n});\n\nmount();\n"],"names":["ROOT_ID","ensureShadow","host","UI","input","setInput","useState","out","setOut","portRef","useRef","useEffect","style","ask","msg","p","jwt","resolve","items","jsxs","jsx","e","mount","shadow","prevMount","mountEl","createRoot","getTargetRect","sel","rect","active","positionPopup","m"],"mappings":"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"}